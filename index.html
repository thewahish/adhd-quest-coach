<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Coach - Your ADHD-Friendly RPG Life System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header Section */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Quest Section */
        .quest-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .quest-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .quest-list {
            list-style: none;
        }

        .quest-item {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .quest-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .quest-item.completed {
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .quest-item.urgent {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .quest-item.locked {
            opacity: 0.5;
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .quest-item.locked:hover {
            background: #f5f5f5;
            transform: none;
        }

        .quest-chain-indicator {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 8px;
        }

        .quest-chain-locked {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #888;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .expand-chain-btn {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .expand-chain-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .quest-chain-list {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 3px dashed #667eea;
            display: none;
        }

        .quest-chain-list.expanded {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }

        .chain-step {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #ddd;
        }

        .chain-step.current {
            border-left-color: #667eea;
            background: #f0f4ff;
        }

        .chain-step.completed-step {
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .chain-step.locked-step {
            opacity: 0.5;
            background: #f9f9f9;
        }

        .quest-icon {
            font-size: 2em;
            min-width: 50px;
            text-align: center;
        }

        .quest-content {
            flex: 1;
        }

        .quest-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #333;
        }

        .quest-category {
            font-size: 0.85em;
            color: #888;
            text-transform: uppercase;
        }

        .quest-checkbox {
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        /* Mood Tracker */
        .mood-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .mood-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .mood-btn {
            font-size: 3em;
            border: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mood-btn:hover {
            transform: scale(1.1);
            background: #e9ecef;
        }

        .mood-btn.selected {
            background: #667eea;
            transform: scale(1.15);
        }

        /* Input Section */
        .input-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        textarea, input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            margin-top: 10px;
            resize: vertical;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .mood-btn {
                font-size: 2em;
                padding: 15px;
            }
        }

        .category-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 10px;
        }

        .category-work {
            background: #e3f2fd;
            color: #1976d2;
        }

        .category-personal {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .category-health {
            background: #e8f5e9;
            color: #388e3c;
        }

        .category-urgent {
            background: #ffebee;
            color: #c62828;
        }

        .hidden {
            display: none;
        }

        /* Voice Input Styles */
        .voice-input-container {
            position: relative;
            margin-top: 10px;
        }

        .mic-button {
            position: absolute;
            right: 15px;
            bottom: 15px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .mic-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .mic-button.recording {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
            }
        }

        .recording-indicator {
            display: none;
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        .recording-indicator.active {
            display: block;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .browser-support-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <h1>‚öîÔ∏è Quest Coach</h1>
                    <p class="subtitle">Your ADHD-Friendly RPG Life System</p>
                    <p class="subtitle" id="player-title">Level up one quest at a time, at your own pace</p>
                </div>
                <button id="toggle-sync-btn" onclick="toggleSyncControls()" style="background: #6c757d; padding: 8px 15px; font-size: 0.85em; border-radius: 50px; margin-top: 10px;">
                    ‚öôÔ∏è Sync
                </button>
            </div>

            <!-- GitHub Sync Controls (Collapsible) -->
            <div id="sync-controls" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0; display: none; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center;">
                <button id="sync-push-btn" onclick="syncToGitHub()" style="background: #28a745; padding: 10px 20px; font-size: 0.9em;">
                    ‚¨ÜÔ∏è Sync to GitHub
                </button>
                <button id="sync-pull-btn" onclick="syncFromGitHub()" style="background: #17a2b8; padding: 10px 20px; font-size: 0.9em;">
                    ‚¨áÔ∏è Load from GitHub
                </button>
                <button onclick="exportForProjectSync()" style="background: #ff9800; padding: 10px 20px; font-size: 0.9em;" title="Download state to sync with project folders">
                    üìÅ Sync to Projects
                </button>
                <button onclick="showSyncSettings()" style="background: #6c757d; padding: 10px 20px; font-size: 0.9em;">
                    ‚öôÔ∏è Sync Settings
                </button>
                <span id="sync-status" style="color: #ffc107; font-size: 0.85em; margin-left: 10px;">
                    Not configured
                </span>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üéØ XP Points</h3>
                <div class="stat-value" id="xp-points">0</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="xp-progress" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üèÜ Level</h3>
                <div class="stat-value" id="player-level">1</div>
                <p style="color: #888; margin-top: 10px;">Keep completing quests!</p>
            </div>

            <div class="stat-card">
                <h3>‚úÖ Quests Completed</h3>
                <div class="stat-value"><span id="completed-quests">0</span>/<span id="total-quests">0</span></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="quest-progress" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üî• Current Streak</h3>
                <div class="stat-value" id="streak">0</div>
                <p style="color: #888; margin-top: 10px;">days in a row</p>
            </div>
        </div>

        <!-- Mood Check -->
        <div class="mood-section">
            <h2>üòä How are you feeling today?</h2>
            <p style="color: #666; margin-bottom: 10px;">Select your current mood:</p>
            <div class="mood-buttons">
                <button class="mood-btn" onclick="selectMood('amazing', 'ü§©')">ü§©</button>
                <button class="mood-btn" onclick="selectMood('good', 'üòä')">üòä</button>
                <button class="mood-btn" onclick="selectMood('okay', 'üòê')">üòê</button>
                <button class="mood-btn" onclick="selectMood('struggling', 'üòî')">üòî</button>
                <button class="mood-btn" onclick="selectMood('overwhelmed', 'üò∞')">üò∞</button>
            </div>
            <div id="mood-message" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: none;">
                <p id="mood-text"></p>
            </div>
        </div>

        <!-- Active Quests -->
        <div class="quest-section">
            <h2>‚öîÔ∏è Active Quests</h2>
            <p style="color: #666; margin-bottom: 15px;">Focus on these right now. Keep it manageable!</p>
            <ul class="quest-list" id="quest-list">
                <!-- Quests will be populated here -->
            </ul>
            <button onclick="showAddQuest()">‚ûï Add New Quest</button>
            <button onclick="toggleInventory()" style="background: #6c757d; margin-left: 10px;">üì¶ Quest Inventory (<span id="inventory-count">0</span>)</button>
        </div>

        <!-- Quest Inventory (Hidden by default) -->
        <div class="quest-section hidden" id="inventory-section">
            <h2>üì¶ Quest Inventory</h2>
            <p style="color: #666; margin-bottom: 15px;">All your available quests. Pull them into Active when you have the stamina!</p>

            <!-- Filter buttons -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="filterInventory('all')" style="background: #6c757d; padding: 10px 20px; font-size: 0.9em;">All</button>
                <button onclick="filterInventory('urgent')" style="background: #dc3545; padding: 10px 20px; font-size: 0.9em;">üö® Urgent</button>
                <button onclick="filterInventory('work')" style="background: #667eea; padding: 10px 20px; font-size: 0.9em;">üíº Work</button>
                <button onclick="filterInventory('awaiting_client')" style="background: #ffc107; padding: 10px 20px; font-size: 0.9em;">‚è≥ Awaiting Client</button>
                <button onclick="filterInventory('planning')" style="background: #17a2b8; padding: 10px 20px; font-size: 0.9em;">üìã Planning</button>
            </div>

            <ul class="quest-list" id="inventory-list">
                <!-- Inventory quests will be populated here -->
            </ul>
            <button onclick="toggleInventory()" style="background: #6c757d;">Close Inventory</button>
        </div>

        <!-- Add Quest Section (Hidden by default) -->
        <div class="input-section hidden" id="add-quest-section">
            <h2>‚ûï Add New Quest</h2>
            <input type="text" id="quest-title-input" placeholder="What quest do you want to tackle?">
            <select id="quest-category" style="margin-top: 15px; padding: 15px;">
                <option value="work">üíº Work</option>
                <option value="personal">üè† Personal</option>
                <option value="health">‚ù§Ô∏è Health</option>
                <option value="urgent">üö® Urgent</option>
            </select>
            <div style="margin-top: 15px;">
                <button onclick="addQuest()">Add Quest</button>
                <button onclick="cancelAddQuest()" style="background: #6c757d;">Cancel</button>
            </div>
        </div>

        <!-- Brain Dump Section -->
        <div class="input-section">
            <h2>üß† Brain Dump</h2>
            <p style="color: #666; margin-bottom: 10px;">Got thoughts racing? Dump them here by typing or speaking. I'll help you organize them.</p>
            <div class="voice-input-container">
                <textarea id="brain-dump" rows="5" placeholder="Type or click the mic to speak..."></textarea>
                <button class="mic-button" id="mic-button" onclick="toggleVoiceInput()" title="Click to speak">üé§</button>
            </div>
            <div id="recording-indicator" class="recording-indicator">
                üî¥ Recording... (Click mic again to stop)
            </div>
            <div id="browser-warning" class="browser-support-warning">
                Voice input not supported in your browser. Please use Chrome, Edge, or Safari.
            </div>
            <button onclick="processBrainDump()">Process Thoughts</button>
        </div>

        <!-- Daily Reflection (End of day) -->
        <div class="input-section">
            <h2>üìù Daily Reflection</h2>
            <p style="color: #666; margin-bottom: 10px;">Before you rest, let's reflect on your day:</p>
            <textarea id="daily-reflection" rows="4" placeholder="What went well today? What could be better tomorrow?"></textarea>
            <button onclick="saveReflection()">Save Reflection</button>
        </div>
    </div>

    <!-- GitHub Sync Settings Modal -->
    <div id="sync-settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <h2 style="color: #667eea; margin-bottom: 20px;">‚öôÔ∏è GitHub Sync Settings</h2>

            <div style="margin-bottom: 25px;">
                <h3 style="color: #333; font-size: 1.1em; margin-bottom: 10px;">üìù Setup Instructions:</h3>
                <ol style="color: #666; line-height: 1.8; margin-left: 20px;">
                    <li>Go to <a href="https://github.com/settings/tokens" target="_blank" style="color: #667eea;">GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)</a></li>
                    <li>Click "Generate new token (classic)"</li>
                    <li>Give it a name like "Quest Coach Sync"</li>
                    <li>Select scope: <strong>repo</strong> (full control of private repositories)</li>
                    <li>Click "Generate token"</li>
                    <li>Copy the token and paste it below</li>
                </ol>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px;">GitHub Personal Access Token:</label>
                <input type="password" id="github-token-input" placeholder="ghp_xxxxxxxxxxxx" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95em;">
                <div style="display: flex; gap: 10px; margin-top: 8px; align-items: center;">
                    <p style="color: #888; font-size: 0.85em; margin: 0;">üîí Stored securely in your browser's localStorage</p>
                    <button type="button" onclick="showTokenMask()" style="background: #6c757d; padding: 5px 10px; font-size: 0.8em;">üëÅÔ∏è Show Token</button>
                </div>
                <p id="token-status" style="color: #28a745; font-size: 0.85em; margin-top: 5px; display: none;">‚úÖ Token already saved for this browser</p>
                <p style="color: #ff9800; font-size: 0.85em; margin-top: 8px; background: #fff3cd; padding: 8px; border-radius: 5px;">
                    ‚ö†Ô∏è <strong>Important:</strong> Each browser/domain has separate storage. If you use both local file (file:///) and web (https://), you need to configure each separately.
                </p>
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: flex; align-items: center; color: #333; cursor: pointer;">
                    <input type="checkbox" id="auto-sync-checkbox" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                    <span>Enable auto-sync (syncs 5 seconds after each change)</span>
                </label>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeSyncSettings()" style="background: #6c757d; padding: 12px 25px;">
                    Cancel
                </button>
                <button onclick="saveSyncSettings()" style="background: #28a745; padding: 12px 25px;">
                    üíæ Save Settings
                </button>
            </div>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                <h3 style="color: #333; font-size: 1em; margin-bottom: 10px;">üí° How it works:</h3>
                <ul style="color: #666; line-height: 1.8; margin-left: 20px; font-size: 0.9em;">
                    <li><strong>‚¨ÜÔ∏è Sync to GitHub:</strong> Pushes your current progress to GitHub (overwrites remote)</li>
                    <li><strong>‚¨áÔ∏è Load from GitHub:</strong> Loads progress from GitHub (overwrites local)</li>
                    <li><strong>Auto-sync:</strong> Automatically pushes to GitHub 5 seconds after any change</li>
                    <li><strong>Result:</strong> Access same progress on all devices! üéâ</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Include Quest Data -->
    <script src="all-projects-quests.js"></script>

    <!-- Include GitHub Sync Script -->
    <script src="github-sync.js"></script>

    <!-- Include Quest Importer -->
    <script src="quest-importer.js"></script>

    <!-- Include Gamification System -->
    <script src="gamification.js"></script>

    <script>
        // Initialize app state
        let appState = {
            xp: 0,
            level: 1,
            streak: 0,
            quests: [], // Active quests only
            inventory: [], // All available quests (not active)
            mood: null,
            lastActiveDate: null,
            brainDumps: [],
            reflections: [],

            // üìä NEW: History tracking for stats/graphs
            history: {
                questCompletions: [],  // Track every quest completed
                levelUps: [],          // Track every level gained
                dailyStats: [],        // Track daily XP/progress
                moodCheckins: [],      // Track mood over time
                sessions: []           // Track when you used Quest Coach
            }
        };

        // Load state from localStorage
        function loadState() {
            const saved = localStorage.getItem('questCoachState');
            if (saved) {
                appState = JSON.parse(saved);
                updateUI();
            } else {
                // Initialize ACTIVE quests (only urgent/high priority - max 5)
                appState.quests = [
                    {
                        id: Date.now() + 1,
                        title: "Order webcam and speakers for client",
                        category: "urgent",
                        completed: false,
                        xpValue: 50,
                        icon: "üö®",
                        status: "active",
                        priority: "urgent",
                        notes: "Installation tomorrow!"
                    },
                    {
                        id: Date.now() + 2,
                        title: "Ministry of Media Syria - Proposal & Presentation",
                        category: "urgent",
                        completed: false,
                        xpValue: 150,
                        icon: "üìÑ",
                        status: "active",
                        priority: "urgent",
                        notes: "Present to minister"
                    },
                    {
                        id: Date.now() + 3,
                        title: "Finish Rakan's Song project",
                        category: "work",
                        completed: false,
                        xpValue: 100,
                        icon: "üéµ",
                        status: "active",
                        priority: "high",
                        notes: ""
                    }
                ];

                // Initialize INVENTORY (all other projects - not shown by default)
                appState.inventory = [
                    {
                        id: Date.now() + 100,
                        title: "Ministry of Child Affairs Syria - Proposal",
                        category: "work",
                        completed: false,
                        xpValue: 100,
                        icon: "üë∂",
                        status: "planning",
                        priority: "medium",
                        notes: "Not urgent but needs attention"
                    },
                    {
                        id: Date.now() + 101,
                        title: "Syria's Tale Song",
                        category: "work",
                        completed: false,
                        xpValue: 75,
                        icon: "üéµ",
                        status: "awaiting_client",
                        priority: "low",
                        notes: "Project with Rima - awaiting feedback"
                    },
                    {
                        id: Date.now() + 102,
                        title: "Reels from Syria Lecture",
                        category: "work",
                        completed: false,
                        xpValue: 50,
                        icon: "üìπ",
                        status: "active",
                        priority: "medium",
                        notes: "Create social media content"
                    },
                    {
                        id: Date.now() + 103,
                        title: "'I Can Do This' Song & Video Clip",
                        category: "work",
                        completed: false,
                        xpValue: 100,
                        icon: "üé¨",
                        status: "awaiting_client",
                        priority: "high",
                        notes: "Project with Rima - 33% complete"
                    },
                    {
                        id: Date.now() + 104,
                        title: "Quest Coach System Development",
                        category: "work",
                        completed: false,
                        xpValue: 200,
                        icon: "üéÆ",
                        status: "active",
                        priority: "high",
                        notes: "This system - ongoing"
                    },
                    {
                        id: Date.now() + 105,
                        title: "Follow up with CPA for K1s (Tax Returns)",
                        category: "urgent",
                        completed: false,
                        xpValue: 75,
                        icon: "üìã",
                        status: "active",
                        priority: "urgent",
                        notes: "2 years to file"
                    },
                    {
                        id: Date.now() + 106,
                        title: "Ministry of Dakhiliyah - PA System",
                        category: "work",
                        completed: false,
                        xpValue: 150,
                        icon: "üîä",
                        status: "active",
                        priority: "high",
                        notes: "Sound system - 20% complete"
                    },
                    {
                        id: Date.now() + 107,
                        title: "Follow up DC Networking Contacts",
                        category: "work",
                        completed: false,
                        xpValue: 50,
                        icon: "ü§ù",
                        status: "active",
                        priority: "medium",
                        notes: "Met Syria president - follow up"
                    },
                    {
                        id: Date.now() + 108,
                        title: "Umayyad Mosque Acoustic Project",
                        category: "work",
                        completed: false,
                        xpValue: 100,
                        icon: "üïå",
                        status: "planning",
                        priority: "medium",
                        notes: "Reviving older project"
                    },
                    {
                        id: Date.now() + 109,
                        title: "Update Personal Website",
                        category: "work",
                        completed: false,
                        xpValue: 75,
                        icon: "üåê",
                        status: "active",
                        priority: "high",
                        notes: "Modernize + add CTAs"
                    },
                    {
                        id: Date.now() + 110,
                        title: "Taxes Filing (2 years)",
                        category: "urgent",
                        completed: false,
                        xpValue: 100,
                        icon: "üí∞",
                        status: "active",
                        priority: "urgent",
                        notes: "Scan papers, organize, submit to CPA"
                    },
                    {
                        id: Date.now() + 111,
                        title: "Nasheed Watani",
                        category: "work",
                        completed: false,
                        xpValue: 75,
                        icon: "üéµ",
                        status: "awaiting_client",
                        priority: "medium",
                        notes: "33% complete - awaiting client"
                    },
                    {
                        id: Date.now() + 112,
                        title: "Audio Courses Launch",
                        category: "urgent",
                        completed: false,
                        xpValue: 200,
                        icon: "üéì",
                        status: "active",
                        priority: "urgent",
                        notes: "Payment gateway, marketing, lessons"
                    },
                    {
                        id: Date.now() + 113,
                        title: "Abdulwareth Lahham Project",
                        category: "urgent",
                        completed: false,
                        xpValue: 100,
                        icon: "üé§",
                        status: "active",
                        priority: "high",
                        notes: "Samples, approval, recording, delivery"
                    },
                    {
                        id: Date.now() + 114,
                        title: "Tamim and Tasnim Song 7",
                        category: "work",
                        completed: false,
                        xpValue: 100,
                        icon: "üë•",
                        status: "awaiting_client",
                        priority: "high",
                        notes: "25% complete - animation pending"
                    },
                    {
                        id: Date.now() + 115,
                        title: "Space Song Aljazeera",
                        category: "work",
                        completed: false,
                        xpValue: 75,
                        icon: "üåå",
                        status: "planning",
                        priority: "low",
                        notes: "In planning phase"
                    },
                    {
                        id: Date.now() + 116,
                        title: "Memory Game",
                        category: "personal",
                        completed: false,
                        xpValue: 50,
                        icon: "üß†",
                        status: "active",
                        priority: "low",
                        notes: "Game development project"
                    },
                    {
                        id: Date.now() + 117,
                        title: "Path of Heroes Game",
                        category: "personal",
                        completed: false,
                        xpValue: 75,
                        icon: "‚öîÔ∏è",
                        status: "active",
                        priority: "low",
                        notes: "Game development project"
                    },
                    {
                        id: Date.now() + 118,
                        title: "Facebook Ad Campaigns - Studio Client Acquisition",
                        category: "work",
                        completed: false,
                        xpValue: 150,
                        icon: "üì±",
                        status: "planning",
                        priority: "high",
                        notes: "Full system: targeting, creative, funnel, follow-up",
                        subtasks: [
                            "Define target audience (location, interests, demographics)",
                            "Create ad creative (images, videos, copy)",
                            "Set up Facebook Business Manager & Ads Account",
                            "Design landing page or booking funnel",
                            "Set budget and campaign structure",
                            "Launch test campaign",
                            "Track metrics (CPA, conversion rate)",
                            "Optimize based on results",
                            "Set up automated follow-up system",
                            "Scale winning campaigns"
                        ]
                    },
                    {
                        id: Date.now() + 119,
                        title: "Email Management System",
                        category: "personal",
                        completed: false,
                        xpValue: 75,
                        icon: "üìß",
                        status: "planning",
                        priority: "medium",
                        notes: "Sort and organize email - discuss later"
                    }
                ];
                saveState();
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('questCoachState', JSON.stringify(appState));
        }

        // Update all UI elements
        function updateUI() {
            // Update stats
            document.getElementById('xp-points').textContent = appState.xp;
            document.getElementById('player-level').textContent = appState.level;
            document.getElementById('streak').textContent = appState.streak;

            // Calculate quest completion
            const completed = appState.quests.filter(q => q.completed).length;
            const total = appState.quests.length;
            document.getElementById('completed-quests').textContent = completed;
            document.getElementById('total-quests').textContent = total;

            // Update progress bars
            const xpForNextLevel = appState.level * 100;
            const xpProgress = (appState.xp % xpForNextLevel) / xpForNextLevel * 100;
            document.getElementById('xp-progress').style.width = xpProgress + '%';

            const questProgress = total > 0 ? (completed / total * 100) : 0;
            document.getElementById('quest-progress').style.width = questProgress + '%';

            // Update quest list
            renderQuests();

            // Check for level up (prevent repeated calls)
            const currentLevelThreshold = appState.level * 100;
            if (appState.xp >= currentLevelThreshold) {
                // Calculate what level we should be at
                const calculatedLevel = Math.floor(appState.xp / 100) + 1;
                if (calculatedLevel > appState.level) {
                    levelUp();
                }
            }
        }

        // Render quest list
        function renderQuests() {
            const questList = document.getElementById('quest-list');
            questList.innerHTML = '';

            // Sort: urgent first, then incomplete, then completed
            const sortedQuests = [...appState.quests].sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                if (a.category === 'urgent' && b.category !== 'urgent') return -1;
                if (a.category !== 'urgent' && b.category === 'urgent') return 1;
                return 0;
            });

            sortedQuests.forEach(quest => {
                // Check if quest is part of a chain and if it's locked
                const isLocked = isQuestLocked(quest);
                const chainInfo = getQuestChainInfo(quest);

                const li = document.createElement('li');
                li.className = `quest-item ${quest.completed ? 'completed' : ''} ${quest.category === 'urgent' ? 'urgent' : ''} ${isLocked ? 'locked' : ''}`;

                let chainHTML = '';
                if (chainInfo.hasChain) {
                    chainHTML = `
                        <span class="quest-chain-indicator">üìä Step ${chainInfo.currentStep}/${chainInfo.totalSteps}</span>
                        ${chainInfo.nextSteps.length > 0 ? `
                            <button class="expand-chain-btn" onclick="toggleChainExpansion(${quest.id})" id="chain-btn-${quest.id}">
                                ‚ñº Show Next Steps (${chainInfo.nextSteps.length})
                            </button>
                            <div class="quest-chain-list" id="chain-${quest.id}">
                                ${chainInfo.nextSteps.map((step, idx) => `
                                    <div class="chain-step ${step.completed ? 'completed-step' : (idx === 0 ? 'current' : 'locked-step')}">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span>${step.completed ? '‚úÖ' : (idx === 0 ? 'üìç' : 'üîí')}</span>
                                            <div style="flex: 1;">
                                                <div style="font-weight: ${idx === 0 ? 'bold' : 'normal'};">${step.title}</div>
                                                <small style="color: #888;">+${step.xpValue} XP</small>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                }

                let lockedHTML = '';
                if (isLocked && chainInfo.blockingQuest) {
                    lockedHTML = `
                        <div class="quest-chain-locked">
                            <span>üîí</span>
                            <span>Complete "<strong>${chainInfo.blockingQuest.title}</strong>" first</span>
                        </div>
                    `;
                }

                li.innerHTML = `
                    <div class="quest-icon">${quest.icon}</div>
                    <div class="quest-content" style="flex: 1;">
                        <div class="quest-title">
                            ${quest.title}
                            <span class="category-badge category-${quest.category}">${quest.category}</span>
                            ${chainHTML}
                        </div>
                        <div class="quest-category">
                            +${quest.xpValue} XP
                            ${quest.notes ? '<br><small style="color:#888;">' + quest.notes + '</small>' : ''}
                            ${lockedHTML}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button onclick="deactivateQuest(${quest.id})"
                                style="padding: 5px 10px; font-size: 0.75em; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;"
                                title="Move to inventory">
                            üì¶
                        </button>
                        <input type="checkbox" class="quest-checkbox" ${quest.completed ? 'checked' : ''} ${isLocked ? 'disabled' : ''}
                               onchange="toggleQuest(${quest.id})" title="${isLocked ? 'Complete previous quest first' : 'Mark as complete'}">
                    </div>
                `;
                questList.appendChild(li);
            });

            if (sortedQuests.length === 0) {
                questList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No active quests. Add one to get started!</p>';
            }
        }

        // Toggle chain expansion
        function toggleChainExpansion(questId) {
            const chainList = document.getElementById(`chain-${questId}`);
            const btn = document.getElementById(`chain-btn-${questId}`);

            if (chainList.classList.contains('expanded')) {
                chainList.classList.remove('expanded');
                btn.textContent = btn.textContent.replace('‚ñ≤ Hide', '‚ñº Show');
            } else {
                chainList.classList.add('expanded');
                btn.textContent = btn.textContent.replace('‚ñº Show', '‚ñ≤ Hide');
            }
        }

        // Check if quest is locked (requires previous quest completion)
        function isQuestLocked(quest) {
            if (!quest.requiresQuest) return false;

            // Find the required quest by questId (string)
            const requiredQuest = appState.quests.find(q => q.questId === quest.requiresQuest);
            if (!requiredQuest) {
                // Also check inventory
                const inventoryQuest = appState.inventory?.find(q => q.questId === quest.requiresQuest);
                return inventoryQuest ? !inventoryQuest.completed : false;
            }

            return !requiredQuest.completed;
        }

        // Get quest chain information
        function getQuestChainInfo(quest) {
            const info = {
                hasChain: false,
                currentStep: 1,
                totalSteps: 1,
                nextSteps: [],
                blockingQuest: null
            };

            // If quest has a chain property with next steps
            if (quest.questChain && Array.isArray(quest.questChain)) {
                info.hasChain = true;
                info.nextSteps = quest.questChain;
                info.totalSteps = 1 + quest.questChain.length;
                info.currentStep = 1;
            }

            // If quest requires another quest, find the blocking quest by questId
            if (quest.requiresQuest) {
                info.blockingQuest = appState.quests.find(q => q.questId === quest.requiresQuest) ||
                                    appState.inventory?.find(q => q.questId === quest.requiresQuest);
            }

            return info;
        }

        // Toggle quest completion
        function toggleQuest(questId) {
            const quest = appState.quests.find(q => q.id === questId);
            if (quest) {
                // Check if quest is locked
                if (isQuestLocked(quest) && !quest.completed) {
                    const chainInfo = getQuestChainInfo(quest);
                    if (chainInfo.blockingQuest) {
                        showNotification(`üîí Complete "${chainInfo.blockingQuest.title}" first!`);
                    } else {
                        showNotification('üîí This quest is locked. Complete the previous quest first!');
                    }
                    updateUI(); // Refresh to uncheck the checkbox
                    return;
                }

                quest.completed = !quest.completed;

                if (quest.completed) {
                    // Award XP
                    appState.xp += quest.xpValue;
                    let totalXP = quest.xpValue;

                    // üìä Log completion to history
                    if (!appState.history) appState.history = { questCompletions: [], levelUps: [], dailyStats: [], moodCheckins: [], sessions: [] };
                    appState.history.questCompletions.push({
                        questId: quest.id,
                        questName: quest.title,
                        xpEarned: quest.xpValue,
                        category: quest.category,
                        completedAt: new Date().toISOString()
                    });

                    // Update daily stats
                    updateDailyStats(quest.xpValue, 1);

                    // üéÆ GAMIFICATION: Check for achievements
                    if (typeof checkAchievements === 'function') {
                        const newAchievements = checkAchievements(appState);
                        newAchievements.forEach(achievement => {
                            appState.xp += achievement.xpBonus;
                            totalXP += achievement.xpBonus;
                            showAchievementPopup(achievement);
                        });
                    }

                    // üéÆ GAMIFICATION: Combo system
                    if (typeof incrementCombo === 'function') {
                        const comboBonus = incrementCombo(quest.xpValue);
                        if (comboBonus > 0) {
                            appState.xp += comboBonus;
                            totalXP += comboBonus;
                        }
                    }

                    // üéÆ GAMIFICATION: Quest complete animation
                    if (typeof showQuestCompleteAnimation === 'function') {
                        showQuestCompleteAnimation(totalXP);
                    } else {
                        showNotification(`üéâ Quest completed! +${totalXP} XP`);
                    }
                } else {
                    // Remove XP
                    appState.xp -= quest.xpValue;

                    // üìä Remove from history if uncompleted
                    if (appState.history && appState.history.questCompletions) {
                        const index = appState.history.questCompletions.findIndex(
                            c => c.questId === quest.id && c.questName === quest.title
                        );
                        if (index > -1) {
                            appState.history.questCompletions.splice(index, 1);
                        }
                    }

                    // Update daily stats
                    updateDailyStats(-quest.xpValue, -1);
                }

                saveState();
                updateUI();
            }
        }

        // Level up
        function levelUp() {
            const xpForNextLevel = appState.level * 100;

            // Only level up if we have enough XP and haven't already leveled up
            if (appState.xp >= xpForNextLevel) {
                appState.level++;

                // üìä Log level up to history
                if (!appState.history) appState.history = { questCompletions: [], levelUps: [], dailyStats: [], moodCheckins: [], sessions: [] };
                appState.history.levelUps.push({
                    level: appState.level,
                    totalXP: appState.xp,
                    leveledUpAt: new Date().toISOString()
                });

                saveState(); // üîß Save the level increase!

                // üéÆ GAMIFICATION: Level up celebration
                if (typeof showLevelUpCelebration === 'function') {
                    showLevelUpCelebration(appState.level);
                } else {
                    showNotification(`üéä LEVEL UP! You're now level ${appState.level}!`);
                    // Play success sound
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCx+zPLTgjMGHm7A7+OZURE');
                    audio.volume = 0.5;
                    audio.play().catch(() => {});
                }

                // üéÆ GAMIFICATION: Update rank title
                if (typeof updatePlayerTitle === 'function') {
                    updatePlayerTitle();
                }

                // Check if there's another level to gain
                const newXpForNextLevel = appState.level * 100;
                if (appState.xp >= newXpForNextLevel) {
                    // Recursive level up for multiple levels at once
                    setTimeout(() => levelUp(), 500);
                }
            }
        }

        // Show notification
        function showNotification(message) {
            // Simple alert for now - can be enhanced with better UI
            alert(message);
        }

        // Select mood
        function selectMood(mood, emoji) {
            appState.mood = { mood, emoji, date: new Date().toISOString() };

            // üìä Log mood check-in to history
            if (!appState.history) appState.history = { questCompletions: [], levelUps: [], dailyStats: [], moodCheckins: [], sessions: [] };
            appState.history.moodCheckins.push({
                mood: mood,
                emoji: emoji,
                timestamp: new Date().toISOString()
            });

            // Update button states
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Show encouraging message based on mood
            const moodMessages = {
                'amazing': "That's fantastic! You're on fire today! üî• Let's tackle those quests!",
                'good': "Great to hear! Keep that positive energy going! ‚ú®",
                'okay': "That's perfectly fine. Let's take it one step at a time. üå±",
                'struggling': "I hear you. Let's focus on just ONE small thing today. You got this. üí™",
                'overwhelmed': "It's okay to feel this way. Let's break things down into tiny, manageable pieces. Take a deep breath. üßò"
            };

            const moodDiv = document.getElementById('mood-message');
            const moodText = document.getElementById('mood-text');
            moodText.textContent = moodMessages[mood];
            moodDiv.style.display = 'block';

            // Update last active date and streak
            const today = new Date().toDateString();
            const lastActive = appState.lastActiveDate ? new Date(appState.lastActiveDate).toDateString() : null;

            if (lastActive !== today) {
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                if (lastActive === yesterday) {
                    appState.streak++;
                } else if (lastActive !== null) {
                    appState.streak = 1;
                } else {
                    appState.streak = 1;
                }
                appState.lastActiveDate = new Date().toISOString();
            }

            saveState();
            updateUI();
        }

        // Show add quest section
        function showAddQuest() {
            document.getElementById('add-quest-section').classList.remove('hidden');
        }

        // Cancel add quest
        function cancelAddQuest() {
            document.getElementById('add-quest-section').classList.add('hidden');
            document.getElementById('quest-title-input').value = '';
        }

        // Add new quest
        function addQuest() {
            const title = document.getElementById('quest-title-input').value.trim();
            const category = document.getElementById('quest-category').value;

            if (!title) {
                alert('Please enter a quest title!');
                return;
            }

            const categoryIcons = {
                'work': 'üíº',
                'personal': 'üè†',
                'health': '‚ù§Ô∏è',
                'urgent': 'üö®'
            };

            const xpValues = {
                'work': 75,
                'personal': 50,
                'health': 100,
                'urgent': 50
            };

            const newQuest = {
                id: Date.now(),
                title: title,
                category: category,
                completed: false,
                xpValue: xpValues[category],
                icon: categoryIcons[category]
            };

            appState.quests.push(newQuest);
            saveState();
            updateUI();
            cancelAddQuest();
            showNotification('‚úÖ New quest added!');
        }

        // Voice input functionality
        let recognition = null;
        let isRecording = false;

        // Initialize speech recognition
        function initSpeechRecognition() {
            // Check browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                document.getElementById('browser-warning').style.display = 'block';
                document.getElementById('mic-button').style.display = 'none';
                return false;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            let finalTranscript = '';

            recognition.onstart = function() {
                console.log('Speech recognition started');
                isRecording = true;
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Update textarea with transcript
                const textarea = document.getElementById('brain-dump');
                const currentText = textarea.value;

                // Only update if there's new content
                if (finalTranscript) {
                    textarea.value = currentText + finalTranscript;
                    finalTranscript = '';

                    // Auto-scroll to bottom
                    textarea.scrollTop = textarea.scrollHeight;
                }
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    // Don't stop recording for no-speech error
                    return;
                }
                stopRecording();
                alert('Error with voice input: ' + event.error);
            };

            recognition.onend = function() {
                if (isRecording) {
                    // Restart if user didn't manually stop
                    try {
                        recognition.start();
                    } catch (e) {
                        console.log('Recognition ended');
                    }
                }
            };

            return true;
        }

        // Toggle voice input
        function toggleVoiceInput() {
            if (!recognition) {
                const initialized = initSpeechRecognition();
                if (!initialized) return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // Start recording
        function startRecording() {
            try {
                recognition.start();
                isRecording = true;

                // Update UI
                document.getElementById('mic-button').classList.add('recording');
                document.getElementById('recording-indicator').classList.add('active');

                // Focus textarea
                document.getElementById('brain-dump').focus();

                console.log('Recording started successfully');
            } catch (e) {
                console.error('Error starting recognition:', e);
                alert('Could not start voice input: ' + e.message + '\n\nMake sure you:\n1. Granted microphone permission\n2. Are using Chrome, Edge, or Safari\n3. Have a working microphone');
                stopRecording();
            }
        }

        // Stop recording
        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;

            // Update UI
            document.getElementById('mic-button').classList.remove('recording');
            document.getElementById('recording-indicator').classList.remove('active');
        }

        // === INVENTORY SYSTEM ===

        let currentInventoryFilter = 'all';

        // Toggle inventory visibility
        function toggleInventory() {
            const inventorySection = document.getElementById('inventory-section');
            inventorySection.classList.toggle('hidden');

            if (!inventorySection.classList.contains('hidden')) {
                renderInventory();
            }
        }

        // Render inventory quests
        function renderInventory() {
            const inventoryList = document.getElementById('inventory-list');
            const inventoryCount = document.getElementById('inventory-count');

            inventoryCount.textContent = appState.inventory.length;

            inventoryList.innerHTML = '';

            let filtered = appState.inventory;

            // Apply filter
            if (currentInventoryFilter !== 'all') {
                if (currentInventoryFilter === 'urgent') {
                    filtered = appState.inventory.filter(q => q.priority === 'urgent');
                } else if (currentInventoryFilter === 'awaiting_client' || currentInventoryFilter === 'planning') {
                    filtered = appState.inventory.filter(q => q.status === currentInventoryFilter);
                } else {
                    filtered = appState.inventory.filter(q => q.category === currentInventoryFilter);
                }
            }

            // Sort by priority
            const priorityOrder = { 'urgent': 0, 'high': 1, 'medium': 2, 'low': 3 };
            filtered.sort((a, b) => {
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });

            filtered.forEach(quest => {
                const li = document.createElement('li');
                const statusEmoji = {
                    'active': '‚ñ∂Ô∏è',
                    'awaiting_client': '‚è≥',
                    'planning': 'üìã',
                    'blocked': 'üö´'
                };

                const priorityBadge = quest.priority === 'urgent' ? '<span style="background:#dc3545;color:white;padding:2px 8px;border-radius:10px;font-size:0.75em;margin-left:5px;">URGENT</span>' : '';

                li.className = `quest-item`;
                li.innerHTML = `
                    <div class="quest-icon">${quest.icon}</div>
                    <div class="quest-content">
                        <div class="quest-title">
                            ${quest.title}
                            ${priorityBadge}
                        </div>
                        <div class="quest-category">
                            ${statusEmoji[quest.status] || ''} ${quest.status.replace('_', ' ')} ‚Ä¢ +${quest.xpValue} XP
                            ${quest.notes ? '<br><small style="color:#888;">' + quest.notes + '</small>' : ''}
                        </div>
                    </div>
                    <button onclick="activateQuest(${quest.id})" style="padding: 8px 15px; font-size: 0.85em; background: #28a745;">
                        ‚¨ÜÔ∏è Activate
                    </button>
                `;
                inventoryList.appendChild(li);
            });

            if (filtered.length === 0) {
                inventoryList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No quests match this filter.</p>';
            }
        }

        // Filter inventory
        function filterInventory(filter) {
            currentInventoryFilter = filter;
            renderInventory();
        }

        // Move quest from inventory to active
        function activateQuest(questId) {
            const questIndex = appState.inventory.findIndex(q => q.id === questId);
            if (questIndex > -1) {
                const quest = appState.inventory.splice(questIndex, 1)[0];
                appState.quests.push(quest);
                saveState();
                updateUI();
                renderInventory();
                showNotification(`‚úÖ "${quest.title}" activated! Let's do this!`);
            }
        }

        // Move quest from active to inventory
        function deactivateQuest(questId) {
            const questIndex = appState.quests.findIndex(q => q.id === questId);
            if (questIndex > -1) {
                const quest = appState.quests.splice(questIndex, 1)[0];
                quest.completed = false; // Reset completion when moving to inventory
                appState.inventory.push(quest);
                saveState();
                updateUI();
                showNotification(`üì¶ "${quest.title}" moved to inventory.`);
            }
        }

        // Update the updateUI function to include inventory count
        const originalUpdateUI = updateUI;
        updateUI = function() {
            if (typeof originalUpdateUI === 'function') {
                originalUpdateUI();
            }

            // Update inventory count
            const inventoryCount = document.getElementById('inventory-count');
            if (inventoryCount) {
                inventoryCount.textContent = appState.inventory ? appState.inventory.length : 0;
            }

            // Render inventory if visible
            const inventorySection = document.getElementById('inventory-section');
            if (inventorySection && !inventorySection.classList.contains('hidden')) {
                renderInventory();
            }
        };

        // === END INVENTORY SYSTEM ===

        // Process brain dump
        function processBrainDump() {
            // Stop recording if active
            if (isRecording) {
                stopRecording();
            }

            const dump = document.getElementById('brain-dump').value.trim();

            if (!dump) {
                alert('Please write or speak something first!');
                return;
            }

            appState.brainDumps.push({
                content: dump,
                date: new Date().toISOString()
            });

            saveState();

            alert('üí≠ Brain dump saved! Take a deep breath. We\'ll organize this together.');
            document.getElementById('brain-dump').value = '';
        }

        // Save daily reflection
        function saveReflection() {
            const reflection = document.getElementById('daily-reflection').value.trim();

            if (!reflection) {
                alert('Please write your reflection first!');
                return;
            }

            appState.reflections.push({
                content: reflection,
                date: new Date().toISOString()
            });

            saveState();

            alert('üìù Reflection saved! Rest well, you did great today! üåô');
            document.getElementById('daily-reflection').value = '';
        }

        // üìä Update daily stats helper
        function updateDailyStats(xpChange, questsChange) {
            if (!appState.history) appState.history = { questCompletions: [], levelUps: [], dailyStats: [], moodCheckins: [], sessions: [] };

            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            let todayStats = appState.history.dailyStats.find(s => s.date === today);

            if (!todayStats) {
                // Create new entry for today
                todayStats = {
                    date: today,
                    xpEarned: 0,
                    questsCompleted: 0,
                    mood: appState.mood ? appState.mood.mood : null,
                    brainDumps: appState.brainDumps ? appState.brainDumps.filter(d =>
                        d.date && d.date.startsWith(today)
                    ).length : 0
                };
                appState.history.dailyStats.push(todayStats);
            }

            // Update stats
            todayStats.xpEarned += xpChange;
            todayStats.questsCompleted += questsChange;

            // Keep only last 365 days of stats (to prevent storage bloat)
            if (appState.history.dailyStats.length > 365) {
                appState.history.dailyStats = appState.history.dailyStats.slice(-365);
            }
        }

        // üìä Log session (when user opens Quest Coach)
        function logSession() {
            if (!appState.history) appState.history = { questCompletions: [], levelUps: [], dailyStats: [], moodCheckins: [], sessions: [] };

            appState.history.sessions.push({
                startTime: new Date().toISOString(),
                level: appState.level,
                xp: appState.xp,
                activeQuests: appState.quests ? appState.quests.length : 0
            });

            // Keep only last 100 sessions (to prevent storage bloat)
            if (appState.history.sessions.length > 100) {
                appState.history.sessions = appState.history.sessions.slice(-100);
            }

            saveState();
        }

        // === PROJECT FOLDER SYNC ===

        // Export state for syncing to project folders
        function exportForProjectSync() {
            // Download state file
            if (window.githubSync && typeof window.githubSync.exportStateForProjectSync === 'function') {
                window.githubSync.exportStateForProjectSync(appState);
            } else {
                // Fallback: manual download
                const stateJSON = JSON.stringify(appState, null, 2);
                const blob = new Blob([stateJSON], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'quest-coach-state.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Show instructions
            const instructions = `üìÅ Project Sync Instructions:

1. ‚úÖ Downloaded: quest-coach-state.json

2. Run this command in terminal:
   cd /Volumes/Ai/Projects/adhd-quest-coach
   node sync-projects-cli.js ~/Downloads/quest-coach-state.json

3. This will create/update quest-status.json in each project folder with:
   - Completed quests from Quest Coach
   - XP earned per project
   - Sync timestamps

4. Each project's quest-status.json tracks what's done!

üí° Your quest completions will now sync to individual project folders!`;

            alert(instructions);

            showNotification('‚úÖ State file downloaded! Check your Downloads folder.');
        }

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', function() {
            loadState();

            // üìä Log this session
            logSession();
        });
    </script>
</body>
</html>
